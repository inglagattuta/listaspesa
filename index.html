<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista della Spesa - Famiglia</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background: linear-gradient(to bottom right, #f0f, #0ff); }
  .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; }
  .modal-content { background:white; border-radius:1rem; padding:1rem; max-width:600px; max-height:80vh; overflow-y:auto; position:relative; }
  .close-btn { position:absolute; top:10px; right:10px; font-size:1.5rem; cursor:pointer; }
</style>
</head>
<body>
<div id="app"></div>

<script type="module">
let state = {
  items: [
    {id:1, name:'Pesto', checked:false},
    {id:2, name:'Pane', checked:false},
    {id:3, name:'Pomodoro', checked:false},
    {id:4, name:'Pasta', checked:false}
  ],
  showRecipes: false,
  recipes: []
};

function render() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="p-4">
      <h1 class="text-xl font-bold mb-2">Lista della Spesa</h1>
      ${state.items.map(i => `
        <div>
          <input type="checkbox" ${i.checked?'checked':''} onchange="toggleItem(${i.id})"/> ${i.name}
        </div>
      `).join('')}
      <button onclick="getRecipes()" class="mt-2 p-2 bg-blue-500 text-white rounded">Mostra Ricette</button>
    </div>

    ${state.showRecipes ? `
      <div class="modal">
        <div class="modal-content">
          <span class="close-btn" onclick="state.showRecipes=false; render()">Ã—</span>
          <h2 class="text-lg font-bold mb-2">Ricette Consigliate</h2>
          ${state.recipes.length === 0 ? `<p>Nessuna ricetta trovata.</p>` : ''}
          ${state.recipes.map(r => `
            <div class="mb-2 p-2 bg-yellow-50 rounded">
              <strong>${r.title}</strong>
              <p>${r.description}</p>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}
  `;
}

function toggleItem(id) {
  const item = state.items.find(i=>i.id===id);
  if(item) item.checked = !item.checked;
  render();
}

// Chiamata reale a Gemini / API
async function getRecipes() {
  const selectedIngredients = state.items
    .filter(i => i.checked)
    .map(i => i.name.toLowerCase());

  if(selectedIngredients.length === 0){
    alert("Seleziona almeno un ingrediente!");
    return;
  }

  try {
    // Gemini API endpoint
    const response = await fetch("https://generative.googleapis.com/v1beta2/models/text-bison-001:generateText", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer AIzaSyDKCyRUnX-weGU-wetydzkrFiWd58GmgaI"
      },
      body: JSON.stringify({
        prompt: `Ho questi ingredienti nella mia lista della spesa: ${selectedIngredients.join(', ')}. Consigliami 3 ricette deliziose, con titolo e breve descrizione, basate su questi ingredienti.`,
        temperature: 0.7,
        maxOutputTokens: 300
      })
    });

    const data = await response.json();
    // Gemini restituisce testo libero, quindi estraiamo e formattiamo in array
    let textOutput = data?.candidates?.[0]?.content || "";
    // Split semplice per creare oggetti ricetta (solo demo)
    state.recipes = textOutput.split('\n').filter(t => t.trim() !== '').map((line, idx) => ({
      title: line.split('-')[0] || `Ricetta ${idx+1}`,
      description: line.split('-')[1] || ''
    }));

  } catch(err){
    console.error(err);
    state.recipes = [{title:'Errore connessione', description:'Impossibile contattare Gemini API'}];
  }

  state.showRecipes = true;
  render();
}

render();
</script>
</body>
</html>
