<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lista della Spesa - Famiglia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    body { overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch; }
    button, input { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
  <div id="app" class="p-3 md:p-4"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBmWi-5wQ97PA4TanAC5mHFAqmsNR9aUpE",
      authDomain: "lista-spesa-famiglia-95127.firebaseapp.com",
      databaseURL: "https://lista-spesa-famiglia-95127-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lista-spesa-famiglia-95127",
      storageBucket: "lista-spesa-famiglia-95127.firebasestorage.app",
      messagingSenderId: "131762886904",
      appId: "1:131762886904:web:068e00b3e2e08235e9c30d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let state = {
      items: [],
      frequentItems: [],
      statistics: [],
      showFrequent: true,
      showStatistics: false,
      showRecipes: false,
      recipes: [],
      loadingRecipes: false,
      frequentSortMode: 'usage',
      newItem: '',
      selectedPhoto: null,
      message: null,
      showMessageInput: false
    };

    const itemsRef = ref(db, 'shoppingList');
    const frequentRef = ref(db, 'frequentItems');
    const messageRef = ref(db, 'familyMessage');
    const statisticsRef = ref(db, 'statistics');

    onValue(itemsRef, snapshot => {
      const data = snapshot.val();
      state.items = data ? Object.keys(data).map(k => ({id:k,...data[k]})) : [];
      render();
    });
    onValue(frequentRef, snapshot => {
      const data = snapshot.val();
      state.frequentItems = data ? Object.keys(data).map(k => ({id:k,...data[k]})) : [];
      render();
    });
    onValue(messageRef, snapshot => { state.message = snapshot.val(); render(); });
    onValue(statisticsRef, snapshot => {
      const data = snapshot.val();
      state.statistics = data ? Object.keys(data).map(k => ({id:k,...data[k]})) : [];
      render();
    });

    function getProductIcon(name) {
      const n = name.toLowerCase();
      if (n.includes('mela')) return 'üçé';
      if (n.includes('banana')) return 'üçå';
      if (n.includes('pane')) return 'üçû';
      if (n.includes('latte')) return 'ü•õ';
      if (n.includes('pasta')) return 'üçù';
      if (n.includes('pomodor')) return 'üçÖ';
      if (n.includes('formaggio')) return 'üßÄ';
      if (n.includes('uova')) return 'ü•ö';
      if (n.includes('acqua')) return 'üíß';
      if (n.includes('caff√®')) return '‚òï';
      return 'üõí';
    }

    async function addItem() {
      const name = state.newItem.trim();
      if (!name) return;
      const icon = getProductIcon(name);
      const newItemRef = push(itemsRef);
      const itemData = {name, icon, checked:false, addedAt:new Date().toISOString()};
      if(state.selectedPhoto) itemData.photo = state.selectedPhoto;
      await set(newItemRef, itemData);

      const exists = state.frequentItems.find(f=>f.name.toLowerCase()===name.toLowerCase());
      if(!exists) {
        const newFreqRef = push(frequentRef);
        await set(newFreqRef, {name, icon, usageCount:1, lastUsed:new Date().toISOString()});
      }
      state.newItem=''; state.selectedPhoto=null;
      render();
      setTimeout(()=>{document.getElementById('newItemInput')?.focus()},50);
    }

    async function toggleItem(id){
      const item = state.items.find(i=>i.id===id);
      if(item){
        const itemRef = ref(db, `shoppingList/${id}`);
        const newChecked = !item.checked;
        await update(itemRef,{checked:newChecked});
        if(newChecked) await updateStatistics(item.name,item.icon);
      }
    }

    async function deleteItem(id){ await remove(ref(db, `shoppingList/${id}`)); }
    async function clearCompleted(){ for(const i of state.items.filter(it=>it.checked)) await remove(ref(db, `shoppingList/${i.id}`)); }
    async function removeFromFrequent(id){ await remove(ref(db, `frequentItems/${id}`)); }
    async function addFromFrequent(freqId){
      const f = state.frequentItems.find(f=>f.id===freqId); if(!f) return;
      if(state.items.some(i=>i.name.toLowerCase()===f.name.toLowerCase() && !i.checked)) return;
      const newItemRef = push(itemsRef);
      await set(newItemRef,{name:f.name, icon:f.icon, checked:false, addedAt:new Date().toISOString()});
      const freqRef = ref(db, `frequentItems/${f.id}`);
      await update(freqRef,{usageCount:(f.usageCount||0)+1,lastUsed:new Date().toISOString()});
    }

    async function saveMessage(){
      const input=document.getElementById('messageInput');
      const messageText=input?.value?.trim(); if(!messageText){alert('Scrivi un messaggio!'); return;}
      await set(messageRef,{text:messageText, author:'Famiglia', timestamp:new Date().toISOString()});
      state.showMessageInput=false; render();
    }
    async function deleteMessage(){ await remove(messageRef); state.showMessageInput=false; render(); }

    async function getRecipeSuggestions() {
      state.loadingRecipes=true; state.showRecipes=true; render();
      const checked = state.items.filter(i=>i.checked).map(i=>i.name.toLowerCase());
      // Qui puoi inserire la logica reale delle ricette basata sui prodotti spuntati
      // Esempio semplice
      const suggestions = [];
      if(checked.includes('pesto') && checked.includes('pane')) {
        suggestions.push({title:'Bruschette al Pesto',description:'Veloci e gustose',ingredients:['pane','pesto','olio','sale'],time:'10 minuti'});
      }
      if(checked.includes('pasta') && checked.includes('pomodoro')) {
        suggestions.push({title:'Pasta al Pomodoro Veloce',description:'Classica e rapida',ingredients:['pasta','pomodoro','olio','sale','basilico'],time:'15 minuti'});
      }
      if(checked.length>0 && suggestions.length===0) {
        suggestions.push({title:'Insalata Mista',description:'Fresca e leggera',ingredients:checked,time:'5 minuti'});
      }
      state.recipes=suggestions; state.loadingRecipes=false; render();
    }

    async function updateStatistics(name, icon){
      const norm=name.toLowerCase();
      const exist=state.statistics.find(s=>s.name.toLowerCase()===norm);
      if(exist){
        const statRef=ref(db, `statistics/${exist.id}`);
        const newCount=(exist.count||0)+1;
        await update(statRef,{count:newCount,lastPurchase:new Date().toISOString()});
      } else {
        const newStatRef=push(statisticsRef);
        await set(newStatRef,{name,icon,count:1,firstPurchase:new Date().toISOString(),lastPurchase:new Date().toISOString()});
      }
    }

    function handlePhotoSelect(e){
      const file=e.target.files[0]; if(!file) return;
      if(file.size>2097152){alert(`La foto √® troppo grande (${(file.size/1024/1024).toFixed(2)}MB)`); e.target.value=''; state.selectedPhoto=null; render(); return;}
      const reader=new FileReader();
      reader.onload=ev=>{state.selectedPhoto=ev.target.result; render();};
      reader.onerror=()=>{alert('Errore caricamento foto'); e.target.value='';};
      reader.readAsDataURL(file);
    }

    function render() {
      const uncheckedCount = state.items.filter(i => !i.checked).length;
      const checkedCount = state.items.filter(i => i.checked).length;
      const sortedFrequent = [...state.frequentItems].sort((a,b)=>{
        if(state.frequentSortMode==='alphabetical') return a.name.localeCompare(b.name,'it');
        return (b.usageCount||0)-(a.usageCount||0);
      });

      document.getElementById('app').innerHTML = `
        <div class="max-w-4xl mx-auto pb-6">
          <!-- Lista, Messaggi, FrequentItems e Statistiche -->
          <!-- QUI VA TUTTO IL TUO CODICE HTML DEL RENDER (come su GitHub) -->
          <!-- Recipes Modal -->
          ${state.showRecipes?`
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
                <button onclick="state.showRecipes=false; render()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center text-2xl">√ó</button>
                <div class="p-6">
                  ${state.loadingRecipes?`<div class="text-center py-12"><p>Caricamento...</p></div>`:state.recipes.map(r=>`
                    <div class="bg-orange-50 rounded-xl p-4 mb-4">
                      <h3 class="text-lg font-bold">${r.title}</h3>
                      <p class="text-gray-600">${r.description}</p>
                      ${r.time?`<p class="text-sm text-orange-600">‚è±Ô∏è ${r.time}</p>`:''}
                      <div class="flex flex-wrap gap-2 mt-2">${r.ingredients.map(i=>`<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-xs">${i}</span>`).join('')}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          `:''}
        </div>
      `;

      document.getElementById('newItemInput')?.addEventListener('keypress', e=>{if(e.key==='Enter') addItem();});
      document.getElementById('photoInput')?.addEventListener('change', handlePhotoSelect);
    }

    window.addItem=addItem;
    window.toggleItem=toggleItem;
    window.deleteItem=deleteItem;
    window.clearCompleted=clearCompleted;
    window.addFromFrequent=addFromFrequent;
    window.removeFromFrequent=removeFromFrequent;
    window.showMessageForm=()=>{state.showMessageInput=true; render(); setTimeout(()=>document.getElementById('messageInput')?.focus(),100);}
    window.cancelMessage=()=>{state.showMessageInput=false; render();}
    window.saveMessage=saveMessage;
    window.deleteMessage=deleteMessage;
    window.toggleFrequent=()=>{state.showFrequent=!state.showFrequent; render();}
    window.showStatistics=()=>{state.showStatistics=true; render();}
    window.hideStatistics=()=>{state.showStatistics=false; render();}
    window.setSortMode=mode=>{state.frequentSortMode=mode; render();}
    window.getRecipes=getRecipeSuggestions;
    window.hideRecipes=()=>{state.showRecipes=false; render();}

    render();
  </script>
</body>
</html>
