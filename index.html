<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lista della Spesa - Famiglia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    body {
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }
    button, input {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
  <div id="app" class="p-3 md:p-4"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBmWi-5wQ97PA4TanAC5mHFAqmsNR9aUpE",
      authDomain: "lista-spesa-famiglia-95127.firebaseapp.com",
      databaseURL: "https://lista-spesa-famiglia-95127-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lista-spesa-famiglia-95127",
      storageBucket: "lista-spesa-famiglia-95127.firebasestorage.app",
      messagingSenderId: "131762886904",
      appId: "1:131762886904:web:068e00b3e2e08235e9c30d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let state = {
      items: [],
      frequentItems: [],
      statistics: [],
      showFrequent: true,
      showStatistics: false,
      showRecipes: false,
      recipes: [],
      loadingRecipes: false,
      frequentSortMode: 'usage',
      newItem: '',
      selectedPhoto: null,
      message: null,
      showMessageInput: false
    };

    const itemsRef = ref(db, 'shoppingList');
    const frequentRef = ref(db, 'frequentItems');
    const messageRef = ref(db, 'familyMessage');
    const statisticsRef = ref(db, 'statistics');

    onValue(itemsRef, (snapshot) => {
      const data = snapshot.val();
      state.items = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(frequentRef, (snapshot) => {
      const data = snapshot.val();
      state.frequentItems = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(messageRef, (snapshot) => {
      state.message = snapshot.val();
      render();
    });

    onValue(statisticsRef, (snapshot) => {
      const data = snapshot.val();
      state.statistics = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    function getProductIcon(name) {
      const n = name.toLowerCase();
      if (n.includes('mela') || n.includes('mele')) return 'ðŸŽ';
      if (n.includes('banana') || n.includes('banane')) return 'ðŸŒ';
      if (n.includes('pane')) return 'ðŸž';
      if (n.includes('latte')) return 'ðŸ¥›';
      if (n.includes('pasta')) return 'ðŸ';
      if (n.includes('pomodor')) return 'ðŸ…';
      if (n.includes('formaggio')) return 'ðŸ§€';
      if (n.includes('uova')) return 'ðŸ¥š';
      if (n.includes('acqua')) return 'ðŸ’§';
      if (n.includes('caffÃ¨')) return 'â˜•';
      return 'ðŸ›’';
    }

    async function addItem() {
      const name = state.newItem.trim();
      if (!name) return;

      const icon = getProductIcon(name);
      const newItemRef = push(itemsRef);
      const itemData = {
        name,
        icon,
        checked: false,
        addedAt: new Date().toISOString()
      };

      if (state.selectedPhoto) {
        itemData.photo = state.selectedPhoto;
      }

      await set(newItemRef, itemData);

      const exists = state.frequentItems.find(f => f.name.toLowerCase() === name.toLowerCase());
      if (!exists) {
        const newFreqRef = push(frequentRef);
        await set(newFreqRef, {
          name,
          icon,
          usageCount: 1,
          lastUsed: new Date().toISOString()
        });
      }

      state.newItem = '';
      state.selectedPhoto = null;
      render();
      setTimeout(() => {
        const input = document.getElementById('newItemInput');
        if (input) {
          input.value = '';
          input.focus();
        }
        const photoInput = document.getElementById('photoInput');
        if (photoInput) photoInput.value = '';
      }, 50);
    }

    async function toggleItem(id) {
      const item = state.items.find(i => i.id === id);
      if (item) {
        const itemRef = ref(db, `shoppingList/${id}`);
        const newCheckedState = !item.checked;
        await update(itemRef, { checked: newCheckedState });

        if (newCheckedState) {
          await updateStatistics(item.name, item.icon);
        }
      }
    }

    async function deleteItem(id) {
      await remove(ref(db, `shoppingList/${id}`));
    }

    async function clearCompleted() {
      const completed = state.items.filter(i => i.checked);
      for (const item of completed) {
        await remove(ref(db, `shoppingList/${item.id}`));
      }
    }

    async function removeFromFrequent(id) {
      await remove(ref(db, `frequentItems/${id}`));
    }

    async function addFromFrequent(freqId) {
      const freq = state.frequentItems.find(f => f.id === freqId);
      if (!freq) return;

      const exists = state.items.find(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
      if (exists) return;

      const newItemRef = push(itemsRef);
      await set(newItemRef, {
        name: freq.name,
        icon: freq.icon,
        checked: false,
        addedAt: new Date().toISOString()
      });

      const freqRef = ref(db, `frequentItems/${freq.id}`);
      await update(freqRef, {
        usageCount: (freq.usageCount || 0) + 1,
        lastUsed: new Date().toISOString()
      });
    }

    async function saveMessage() {
      const input = document.getElementById('messageInput');
      const messageText = input?.value?.trim();
      if (!messageText) {
        alert('Scrivi un messaggio prima di pubblicare!');
        return;
      }

      await set(messageRef, {
        text: messageText,
        author: 'Famiglia',
        timestamp: new Date().toISOString()
      });

      state.showMessageInput = false;
      render();
    }

    async function deleteMessage() {
      await remove(messageRef);
      state.showMessageInput = false;
    }

    async function getRecipeSuggestions() {
      state.loadingRecipes = true;
      state.showRecipes = true;
      render();

      const checkedItems = state.items.filter(i => i.checked).map(i => i.name);

      if (checkedItems.length === 0) {
        state.recipes = [{
          title: "Nessun prodotto nel carrello",
          description: "Spunta alcuni prodotti per ricevere suggerimenti di ricette!",
          ingredients: [],
          time: ""
        }];
        state.loadingRecipes = false;
        render();
        return;
      }

      try {
        const response = await fetch("https://api.gemini.recipes/generate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer AIzaSyDKCyRUnX-weGU-wetydzkrFiWd58GmgaI"
          },
          body: JSON.stringify({
            ingredients: checkedItems,
            numberOfRecipes: 3
          })
        });

        const data = await response.json();
        state.recipes = data.recipes || [{
          title: "Errore nel caricamento",
          description: "Non sono riuscito a generare le ricette. Riprova!",
          ingredients: [],
          time: ""
        }];
      } catch (error) {
        console.error("Errore API:", error);
        state.recipes = [{
          title: "Errore di connessione",
          description: "Impossibile contattare il servizio di suggerimenti. Verifica la connessione.",
          ingredients: [],
          time: ""
        }];
      }

      state.loadingRecipes = false;
      render();
    }

    async function updateStatistics(productName, productIcon) {
      const normalizedName = productName.toLowerCase();
      const existingStat = state.statistics.find(s => s.name.toLowerCase() === normalizedName);

      if (existingStat) {
        const statRef = ref(db, `statistics/${existingStat.id}`);
        const newCount = (existingStat.count || 0) + 1;
        await update(statRef, {
          count: newCount,
          lastPurchase: new Date().toISOString()
        });
      } else {
        const newStatRef = push(statisticsRef);
        await set(newStatRef, {
          name: productName,
          icon: productIcon,
          count: 1,
          firstPurchase: new Date().toISOString(),
          lastPurchase: new Date().toISOString()
        });
      }
    }

    function handlePhotoSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const maxSize = 2097152; 
      if (file.size > maxSize) {
        const sizeMB = (file.size / 1024 / 1024).toFixed(2);
        alert(`La foto Ã¨ troppo grande (${sizeMB}MB). Massimo 2MB.`);
        event.target.value = '';
        state.selectedPhoto = null;
        render();
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        state.selectedPhoto = e.target.result;
        render();
      };
      reader.onerror = () => {
        alert('Errore nel caricamento della foto. Riprova!');
        event.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    // Qui va tutto il codice render() identico a prima (non modificato)
    // Per brevitÃ  non lo riscrivo tutto qui, ma va copiato cosÃ¬ comâ€™Ã¨ dal tuo file originale

    window.addItem = addItem;
    window.toggleItem = toggleItem;
    window.deleteItem = deleteItem;
    window.clearCompleted = clearCompleted;
    window.addFromFrequent = addFromFrequent;
    window.removeFromFrequent = removeFromFrequent;
    window.toggleFrequent = () => {
      state.showFrequent = !state.showFrequent;
      render();
    };
    window.showMessageForm = () => {
      state.showMessageInput = true;
      render();
      setTimeout(() => document.getElementById('messageInput')?.focus(), 100);
    };
    window.cancelMessage = () => {
      state.showMessageInput = false;
      render();
    };
    window.saveMessage = saveMessage;
    window.deleteMessage = deleteMessage;
    window.showStatistics = () => {
      state.showStatistics = true;
      render();
    };
    window.hideStatistics = () => {
      state.showStatistics = false;
      render();
    };
    window.setSortMode = (mode) => {
      state.frequentSortMode = mode;
      render();
    };
    window.getRecipes = getRecipeSuggestions;
    window.hideRecipes = () => {
      state.showRecipes = false;
      render();
    };

    render();
  </script>
</body>
</html>
