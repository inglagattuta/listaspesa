<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lista della Spesa - Famiglia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    body {
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }
    button, input {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
  <div id="app" class="p-3 md:p-4"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBmWi-5wQ97PA4TanAC5mHFAqmsNR9aUpE",
      authDomain: "lista-spesa-famiglia-95127.firebaseapp.com",
      databaseURL: "https://lista-spesa-famiglia-95127-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lista-spesa-famiglia-95127",
      storageBucket: "lista-spesa-famiglia-95127.firebasestorage.app",
      messagingSenderId: "131762886904",
      appId: "1:131762886904:web:068e00b3e2e08235e9c30d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let state = {
      items: [],
      frequentItems: [],
      statistics: [],
      showFrequent: true,
      showStatistics: false,
      showRecipes: false,
      recipes: [],
      loadingRecipes: false,
      frequentSortMode: 'usage',
      newItem: '',
      selectedPhoto: null,
      message: null,
      showMessageInput: false
    };

    const itemsRef = ref(db, 'shoppingList');
    const frequentRef = ref(db, 'frequentItems');
    const messageRef = ref(db, 'familyMessage');
    const statisticsRef = ref(db, 'statistics');

    onValue(itemsRef, (snapshot) => {
      const data = snapshot.val();
      state.items = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(frequentRef, (snapshot) => {
      const data = snapshot.val();
      state.frequentItems = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(messageRef, (snapshot) => {
      state.message = snapshot.val();
      render();
    });

    onValue(statisticsRef, (snapshot) => {
      const data = snapshot.val();
      state.statistics = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    function getProductIcon(name) {
      const n = name.toLowerCase();
      if (n.includes('mela') || n.includes('mele')) return 'ğŸ';
      if (n.includes('banana') || n.includes('banane')) return 'ğŸŒ';
      if (n.includes('pane')) return 'ğŸ';
      if (n.includes('latte')) return 'ğŸ¥›';
      if (n.includes('pasta')) return 'ğŸ';
      if (n.includes('pomodor')) return 'ğŸ…';
      if (n.includes('formaggio')) return 'ğŸ§€';
      if (n.includes('uova')) return 'ğŸ¥š';
      if (n.includes('acqua')) return 'ğŸ’§';
      if (n.includes('caffÃ¨')) return 'â˜•';
      return 'ğŸ›’';
    }

    async function addItem() {
      const name = state.newItem.trim();
      if (!name) return;
      const icon = getProductIcon(name);
      const newItemRef = push(itemsRef);
      const itemData = {
        name,
        icon,
        checked: false,
        addedAt: new Date().toISOString()
      };
      if (state.selectedPhoto) itemData.photo = state.selectedPhoto;
      await set(newItemRef, itemData);
      const exists = state.frequentItems.find(f => f.name.toLowerCase() === name.toLowerCase());
      if (!exists) {
        const newFreqRef = push(frequentRef);
        await set(newFreqRef, { name, icon, usageCount: 1, lastUsed: new Date().toISOString() });
      }
      state.newItem = '';
      state.selectedPhoto = null;
      render();
      setTimeout(() => {
        document.getElementById('newItemInput')?.focus();
        document.getElementById('photoInput') && (document.getElementById('photoInput').value = '');
      }, 50);
    }

    async function toggleItem(id) {
      const item = state.items.find(i => i.id === id);
      if (item) {
        const itemRef = ref(db, `shoppingList/${id}`);
        const newCheckedState = !item.checked;
        await update(itemRef, { checked: newCheckedState });
        if (newCheckedState) await updateStatistics(item.name, item.icon);
      }
    }

    async function deleteItem(id) { await remove(ref(db, `shoppingList/${id}`)); }
    async function clearCompleted() { for (const i of state.items.filter(x => x.checked)) await remove(ref(db, `shoppingList/${i.id}`)); }
    async function removeFromFrequent(id) { await remove(ref(db, `frequentItems/${id}`)); }
    async function addFromFrequent(freqId) {
      const freq = state.frequentItems.find(f => f.id === freqId);
      if (!freq) return;
      const exists = state.items.find(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
      if (exists) return;
      const newItemRef = push(itemsRef);
      await set(newItemRef, { name: freq.name, icon: freq.icon, checked: false, addedAt: new Date().toISOString() });
      const freqRef = ref(db, `frequentItems/${freq.id}`);
      await update(freqRef, { usageCount: (freq.usageCount || 0)+1, lastUsed: new Date().toISOString() });
    }

    async function saveMessage() {
      const msg = document.getElementById('messageInput')?.value?.trim();
      if (!msg) { alert('Scrivi un messaggio prima!'); return; }
      await set(messageRef, { text: msg, author: 'Famiglia', timestamp: new Date().toISOString() });
      state.showMessageInput = false;
      render();
    }
    async function deleteMessage() { await remove(messageRef); state.showMessageInput = false; render(); }

    async function updateStatistics(name, icon) {
      const norm = name.toLowerCase();
      const existingStat = state.statistics.find(s => s.name.toLowerCase() === norm);
      if (existingStat) {
        const statRef = ref(db, `statistics/${existingStat.id}`);
        await update(statRef, { count: (existingStat.count||0)+1, lastPurchase: new Date().toISOString() });
      } else {
        const newStatRef = push(statisticsRef);
        await set(newStatRef, { name, icon, count: 1, firstPurchase: new Date().toISOString(), lastPurchase: new Date().toISOString() });
      }
    }

    function handlePhotoSelect(e) {
      const file = e.target.files[0]; if(!file) return;
      if(file.size>2097152){ alert(`Foto troppo grande (${(file.size/1024/1024).toFixed(2)}MB)`); e.target.value=''; state.selectedPhoto=null; render(); return; }
      const reader = new FileReader();
      reader.onload = (ev)=>{ state.selectedPhoto = ev.target.result; render(); };
      reader.onerror = ()=>{ alert('Errore caricamento foto'); e.target.value=''; };
      reader.readAsDataURL(file);
    }

    function getRecipeSuggestions() {
      const checkedItems = state.items.filter(i=>i.checked).map(i=>i.name);
      state.recipes = checkedItems.length>0 ? [
        {title:"Insalata di mele e formaggio", description:"Fresca e veloce con mele, formaggio e noci", ingredients:["mele","formaggio","noci","olio","sale","pepe"], time:"10 min"},
        {title:"Pasta al pomodoro veloce", description:"Pasta semplice con salsa di pomodoro e basilico", ingredients:["pasta","pomodoro","olio","sale","pepe","basilico"], time:"15 min"},
        {title:"Banana smoothie", description:"Frullato dolce e sano con banana e latte", ingredients:["banana","latte","miele"], time:"5 min"}
      ] : [{
        title:"Nessun prodotto selezionato",
        description:"Spunta alcuni prodotti per ricevere suggerimenti",
        ingredients:[], time:""
      }];
      state.showRecipes = true; render();
    }

    function render() {
      const uncheckedCount = state.items.filter(i=>!i.checked).length;
      const checkedCount = state.items.filter(i=>i.checked).length;
      const sortedFrequent = [...state.frequentItems].sort((a,b)=>state.frequentSortMode==='alphabetical'? a.name.localeCompare(b.name,'it'):(b.usageCount||0)-(a.usageCount||0));
      
      document.getElementById('app').innerHTML = `
      <div class="max-w-4xl mx-auto pb-6">

        <!-- Bacheca -->
        ${state.message ? `<div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl shadow-lg p-4 mb-4 relative">
          <button onclick="deleteMessage()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-amber-100 hover:bg-amber-200 text-amber-600 flex items-center justify-center">Ã—</button>
          <div class="flex items-start gap-3 pr-8"><div class="text-3xl">ğŸ“Œ</div><div class="flex-1"><div class="text-xs text-amber-600 font-semibold mb-1">BACHECA FAMIGLIA</div><div class="text-base text-gray-800 font-medium">${state.message.text}</div></div></div></div>` : ''}

        <!-- Lista principale -->
        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 mb-4">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="bg-gradient-to-br from-purple-500 to-pink-500 p-3 rounded-xl text-white text-2xl">ğŸ›’</div>
              <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Lista Spesa</h1>
                <p class="text-sm text-gray-500">ğŸ‘¥ Famiglia</p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <button onclick="showStatistics()" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 text-white hover:shadow-lg active:scale-95 transition-all">
                <span class="text-2xl">ğŸ“Š</span>
                <span class="text-xs font-semibold">Stats</span>
              </button>
              <button onclick="getRecipeSuggestions()" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 text-white hover:shadow-lg active:scale-95 transition-all">
                <span class="text-2xl">ğŸ‘¨â€ğŸ³</span>
                <span class="text-xs font-semibold">Ricette</span>
              </button>
              <div class="text-right">
                <div class="text-3xl font-bold text-purple-600">${uncheckedCount}</div>
                <div class="text-sm text-gray-500">da comprare</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista prodotti -->
        <div class="space-y-3">
          ${state.items.map(item => `
            <div class="bg-white rounded-xl shadow-lg p-4 slide-in ${item.checked?'opacity-60':''}">
              <div class="flex items-center gap-3">
                <button onclick="toggleItem('${item.id}')" class="flex-shrink-0 w-10 h-10 rounded-xl border-2 flex items-center justify-center ${item.checked?'bg-green-500 border-green-500 text-white':'border-gray-300'}">${item.checked?'âœ“':''}</button>
                ${item.photo?`<div class="w-14 h-14 rounded-xl overflow-hidden flex-shrink-0 border-2 border-gray-100"><img src="${item.photo}" alt="${item.name}" class="w-full h-full object-cover" /></div>`:`<div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-3xl flex-shrink-0">${item.icon}</div>`}
                <div class="flex-1 font-semibold text-lg ${item.checked?'line-through text-gray-400':'text-gray-800'}">${item.name}</div>
                <button onclick="deleteItem('${item.id}')" class="w-10 h-10 rounded-xl bg-red-50 hover:bg-red-100 text-red-500 flex items-center justify-center">Ã—</button>
              </div>
            </div>
          `).join('')}
        </div>

        <!-- Prodotti frequenti -->
        <div class="mt-6">
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold text-gray-700">Prodotti Frequenti</h2>
            <select onchange="state.frequentSortMode=this.value; render();" class="text-sm border rounded p-1">
              <option value="usage" ${state.frequentSortMode==='usage'?'selected':''}>Per acquisti</option>
              <option value="alphabetical" ${state.frequentSortMode==='alphabetical'?'selected':''}>Alfabetico</option>
            </select>
          </div>
          <div class="flex flex-wrap gap-3">
            ${sortedFrequent.map(f => `
              <div class="flex flex-col items-center gap-1 bg-white rounded-xl p-2 shadow hover:shadow-md cursor-pointer" onclick="addFromFrequent('${f.id}')">
                <div class="text-xl">${f.icon}</div>
                <div class="text-sm font-medium">${f.name}</div>
                <div class="flex gap-0.5">
                  ${'â˜…'.repeat(f.usageCount||1)}${'â˜†'.repeat(Math.max(0,5-(f.usageCount||1)))}
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Modal Ricette -->
        ${state.showRecipes ? `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="state.showRecipes=false;render();">
          <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 flex justify-between items-center rounded-t-3xl">
              <div>
                <h2 class="text-2xl font-bold">ğŸ‘¨â€ğŸ³ Suggerimenti Ricette</h2>
                <p class="text-orange-100 text-sm mt-1">In base ai prodotti selezionati</p>
              </div>
              <button onclick="state.showRecipes=false;render();" class="w-10 h-10 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 flex items-center justify-center text-2xl">Ã—</button>
            </div>
            <div class="p-6 space-y-4">
              ${state.recipes.map((recipe,index)=>`
                <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl p-5 border-2 border-orange-200 hover:shadow-lg transition-shadow">
                  <div class="flex items-start gap-3 mb-3">
                    <div class="text-3xl">${index===0?'ğŸ¥‡':index===1?'ğŸ¥ˆ':'ğŸ¥‰'}</div>
                    <div class="flex-1">
                      <h3 class="text-xl font-bold text-gray-800 mb-1">${recipe.title}</h3>
                      <p class="text-gray-600 text-sm">${recipe.description}</p>
                    </div>
                    ${recipe.time?`<div class="text-right"><div class="text-sm font-semibold text-orange-600">â±ï¸ ${recipe.time}</div></div>`:''}
                  </div>
                  ${recipe.ingredients&&recipe.ingredients.length>0?`<div class="bg-white rounded-lg p-3 mt-3">
                    <div class="text-xs font-semibold text-gray-600 mb-2">ğŸ“ INGREDIENTI:</div>
                    <div class="flex flex-wrap gap-2">
                      ${recipe.ingredients.map(ing=>`<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-xs font-medium">${ing}</span>`).join('')}
                    </div>
                  </div>`:''}
                </div>`).join('')}
            </div>
          </div>
        </div>` : ''}

        <!-- Modal Statistiche -->
        ${state.showStatistics ? `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="hideStatistics()">
          <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">ğŸ“Š Statistiche Acquisti</h2>
              <button onclick="hideStatistics()" class="text-2xl text-red-500">Ã—</button>
            </div>
            <div class="space-y-3">
              ${state.statistics.map(s => `
                <div class="flex justify-between items-center bg-gray-50 rounded-xl p-3">
                  <div class="flex items-center gap-3">
                    <div class="text-2xl">${s.icon}</div>
                    <div class="text-sm font-medium">${s.name}</div>
                  </div>
                  <div class="text-sm text-gray-600">Acquistato: ${s.count || 0} volte</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>` : ''}

      </div>
      `;
    }

    window.addItem = addItem;
    window.toggleItem = toggleItem;
    window.deleteItem = deleteItem;
    window.clearCompleted = clearCompleted;
    window.addFromFrequent = addFromFrequent;
    window.removeFromFrequent = removeFromFrequent;
    window.showStatistics = ()=>{ state.showStatistics=true; render(); };
    window.hideStatistics = ()=>{ state.showStatistics=false; render(); };
    window.getRecipeSuggestions = getRecipeSuggestions;
    window.handlePhotoSelect = handlePhotoSelect;

    render();
  </script>
</body>
</html>
