<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lista della Spesa - Famiglia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    body {
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }
    button, input {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
  <div id="app" class="p-3 md:p-4">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-6 text-center">
        <div class="text-6xl mb-4">ğŸ›’</div>
        <p class="text-gray-600">Caricamento...</p>
      </div>
    </div>
  </div>

  <script type="module">
    try {
      console.log("Inizio caricamento app...");
      
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      const { getDatabase, ref, onValue, set, push, remove, update } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');

      console.log("Firebase SDK caricato");

      const firebaseConfig = {
        apiKey: "AIzaSyCzn4I_P5WTNdH_CuOBU183_s2YH2MN7QI",
        authDomain: "la-listaspesa-lagattuta.firebaseapp.com",
        projectId: "la-listaspesa-lagattuta",
        storageBucket: "la-listaspesa-lagattuta.firebasestorage.app",
        messagingSenderId: "52992494056",
        appId: "1:52992494056:web:111ba293d95a80c8e47c5d"
      };

      console.log("Config Firebase:", firebaseConfig);

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      console.log("Firebase inizializzato");

      let state = {
        items: [],
        frequentItems: [],
        statistics: [],
        showFrequent: true,
        showStatistics: false,
        showRecipes: false,
        recipes: [],
        loadingRecipes: false,
        frequentSortMode: 'usage',
        newItem: '',
        selectedPhoto: null,
        message: null,
        showMessageInput: false
      };

      const itemsRef = ref(db, 'shoppingList');
      const frequentRef = ref(db, 'frequentItems');
      const messageRef = ref(db, 'familyMessage');
      const statisticsRef = ref(db, 'statistics');

      onValue(itemsRef, (snapshot) => {
        const data = snapshot.val();
        state.items = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
        console.log("Items caricati:", state.items.length);
        render();
      });

      onValue(frequentRef, (snapshot) => {
        const data = snapshot.val();
        state.frequentItems = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
        console.log("Frequent items caricati:", state.frequentItems.length);
        render();
      });

      onValue(messageRef, (snapshot) => {
        state.message = snapshot.val();
        render();
      });

      onValue(statisticsRef, (snapshot) => {
        const data = snapshot.val();
        state.statistics = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
        render();
      });

      function getProductIcon(name) {
        const n = name.toLowerCase();
        if (n.includes('mela') || n.includes('mele')) return 'ğŸ';
        if (n.includes('banana') || n.includes('banane')) return 'ğŸŒ';
        if (n.includes('pane')) return 'ğŸ';
        if (n.includes('latte')) return 'ğŸ¥›';
        if (n.includes('pasta')) return 'ğŸ';
        if (n.includes('pomodor')) return 'ğŸ…';
        if (n.includes('formaggio')) return 'ğŸ§€';
        if (n.includes('uova')) return 'ğŸ¥š';
        if (n.includes('acqua')) return 'ğŸ’§';
        if (n.includes('caffÃ¨')) return 'â˜•';
        return 'ğŸ›’';
      }

      async function addItem() {
        const name = state.newItem.trim();
        if (!name) return;

        const icon = getProductIcon(name);
        const newItemRef = push(itemsRef);
        const itemData = {
          name,
          icon,
          checked: false,
          addedAt: new Date().toISOString()
        };
        
        if (state.selectedPhoto) {
          itemData.photo = state.selectedPhoto;
        }
        
        await set(newItemRef, itemData);

        const exists = state.frequentItems.find(f => f.name.toLowerCase() === name.toLowerCase());
        if (!exists) {
          const newFreqRef = push(frequentRef);
          await set(newFreqRef, {
            name,
            icon,
            usageCount: 1,
            lastUsed: new Date().toISOString()
          });
        }

        state.newItem = '';
        state.selectedPhoto = null;
        render();
        setTimeout(() => {
          const input = document.getElementById('newItemInput');
          if (input) {
            input.value = '';
            input.focus();
          }
          const photoInput = document.getElementById('photoInput');
          if (photoInput) photoInput.value = '';
        }, 50);
      }

      async function toggleItem(id) {
        const item = state.items.find(i => i.id === id);
        if (item) {
          const itemRef = ref(db, `shoppingList/${id}`);
          const newCheckedState = !item.checked;
          await update(itemRef, { checked: newCheckedState });
          
          if (newCheckedState) {
            await updateStatistics(item.name, item.icon);
          }
        }
      }

      async function deleteItem(id) {
        await remove(ref(db, `shoppingList/${id}`));
      }

      async function clearCompleted() {
        const completed = state.items.filter(i => i.checked);
        for (const item of completed) {
          await remove(ref(db, `shoppingList/${item.id}`));
        }
      }

      async function removeFromFrequent(id) {
        await remove(ref(db, `frequentItems/${id}`));
      }

      async function addFromFrequent(freqId) {
        const freq = state.frequentItems.find(f => f.id === freqId);
        if (!freq) return;

        const exists = state.items.find(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
        if (exists) return;

        const newItemRef = push(itemsRef);
        await set(newItemRef, {
          name: freq.name,
          icon: freq.icon,
          checked: false,
          addedAt: new Date().toISOString()
        });

        const freqRef = ref(db, `frequentItems/${freq.id}`);
        await update(freqRef, {
          usageCount: (freq.usageCount || 0) + 1,
          lastUsed: new Date().toISOString()
        });
      }

      async function saveMessage() {
        const input = document.getElementById('messageInput');
        const messageText = input?.value?.trim();
        if (!messageText) {
          alert('Scrivi un messaggio prima di pubblicare!');
          return;
        }

        await set(messageRef, {
          text: messageText,
          author: 'Famiglia',
          timestamp: new Date().toISOString()
        });

        state.showMessageInput = false;
        render();
      }

      async function deleteMessage() {
        await remove(messageRef);
        state.showMessageInput = false;
      }

      async function updateStatistics(productName, productIcon) {
        const normalizedName = productName.toLowerCase();
        const existingStat = state.statistics.find(s => s.name.toLowerCase() === normalizedName);
        
        if (existingStat) {
          const statRef = ref(db, `statistics/${existingStat.id}`);
          const newCount = (existingStat.count || 0) + 1;
          await update(statRef, {
            count: newCount,
            lastPurchase: new Date().toISOString()
          });
        } else {
          const newStatRef = push(statisticsRef);
          await set(newStatRef, {
            name: productName,
            icon: productIcon,
            count: 1,
            firstPurchase: new Date().toISOString(),
            lastPurchase: new Date().toISOString()
          });
        }
      }

      async function getRecipeSuggestions() {
        state.loadingRecipes = true;
        state.showRecipes = true;
        render();

        const checkedItems = state.items.filter(i => i.checked).map(i => i.name);
        
        if (checkedItems.length === 0) {
          state.recipes = [{
            title: "Nessun prodotto nel carrello",
            description: "Spunta alcuni prodotti per ricevere suggerimenti di ricette!",
            ingredients: [],
            time: ""
          }];
          state.loadingRecipes = false;
          render();
          return;
        }

        const ingredientsList = checkedItems.join(', ');
        
        try {
          const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyDKCyRUnX-weGU-wetydzkrFiWd58GmgaI", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: `Ho questi ingredienti nel carrello della spesa: ${ingredientsList}.

Suggeriscimi 3 ricette deliziose che posso preparare usando principalmente questi ingredienti. Possono essere di qualsiasi cucina. Per ogni ricetta fornisci:
- Nome della ricetta
- Breve descrizione (max 2 righe)
- Ingredienti necessari
- Tempo di preparazione

Rispondi SOLO con un JSON valido in questo formato:
[
  {
    "title": "Nome ricetta",
    "description": "Breve descrizione",
    "ingredients": ["ingrediente1", "ingrediente2"],
    "time": "30 minuti"
  }
]`
                }]
              }]
            })
          });

          const data = await response.json();
          
          if (data.candidates && data.candidates[0] && data.candidates[0].content) {
            const textContent = data.candidates[0].content.parts[0].text;
            const cleanText = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').replace(/^[^[{]*/g, '').replace(/[^}\]]*$/g, '').trim();
            
            try {
              state.recipes = JSON.parse(cleanText);
            } catch (e) {
              state.recipes = [{
                title: "Errore nel caricamento",
                description: "Non sono riuscito a generare le ricette. Riprova!",
                ingredients: [],
                time: ""
              }];
            }
          } else {
            throw new Error("Risposta API non valida");
          }
        } catch (error) {
          console.error("Errore API:", error);
          state.recipes = [{
            title: "Errore di connessione",
            description: "Impossibile contattare il servizio. Riprova!",
            ingredients: [],
            time: ""
          }];
        }

        state.loadingRecipes = false;
        render();
      }

      function handlePhotoSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const maxSize = 2097152;
        
        if (file.size > maxSize) {
          const sizeMB = (file.size / 1024 / 1024).toFixed(2);
          alert(`La foto Ã¨ troppo grande (${sizeMB}MB). Massimo 2MB.`);
          event.target.value = '';
          state.selectedPhoto = null;
          render();
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          state.selectedPhoto = e.target.result;
          render();
        };
        reader.onerror = () => {
          alert('Errore nel caricamento della foto. Riprova!');
          event.target.value = '';
        };
        reader.readAsDataURL(file);
      }

      function render() {
        const uncheckedCount = state.items.filter(i => !i.checked).length;
        const checkedCount = state.items.filter(i => i.checked).length;
        
        const sortedFrequent = [...state.frequentItems].sort((a, b) => {
          if (state.frequentSortMode === 'alphabetical') {
            return a.name.localeCompare(b.name, 'it');
          } else {
            return (b.usageCount || 0) - (a.usageCount || 0);
          }
        });

        document.getElementById('app').innerHTML = `
          <div class="max-w-4xl mx-auto pb-6">
            ${state.message ? `
              <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl shadow-lg p-4 mb-4 relative">
                <button onclick="deleteMessage()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-amber-100 hover:bg-amber-200 text-amber-600 flex items-center justify-center">Ã—</button>
                <div class="flex items-start gap-3 pr-8">
                  <div class="text-3xl">ğŸ“Œ</div>
                  <div class="flex-1">
                    <div class="text-xs text-amber-600 font-semibold mb-1">BACHECA FAMIGLIA</div>
                    <div class="text-base text-gray-800 font-medium">${state.message.text}</div>
                  </div>
                </div>
              </div>
            ` : state.showMessageInput ? `
              <div class="bg-white rounded-2xl shadow-xl p-4 mb-4">
                <div class="flex items-center gap-2 mb-3">
                  <div class="text-2xl">ğŸ“Œ</div>
                  <div class="text-lg font-semibold text-gray-700">Nuovo messaggio bacheca</div>
                </div>
                <textarea id="messageInput" placeholder="Scrivi un messaggio..." class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:outline-none text-base resize-none" rows="3"></textarea>
                <div class="flex gap-2 mt-3">
                  <button onclick="saveMessage()" class="flex-1 bg-gradient-to-r from-amber-500 to-yellow-500 text-white px-6 py-3 rounded-xl font-semibold">Pubblica</button>
                  <button onclick="cancelMessage()" class="px-6 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold">Annulla</button>
                </div>
              </div>
            ` : `
              <button onclick="showMessageForm()" class="w-full bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-dashed border-amber-300 rounded-2xl p-4 mb-4 hover:border-amber-400">
                <div class="flex items-center justify-center gap-3 text-amber-600">
                  <div class="text-3xl">ğŸ“Œ</div>
                  <div class="text-lg font-semibold">Aggiungi messaggio bacheca</div>
                </div>
              </button>
            `}

            <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 mb-4">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="bg-gradient-to-br from-purple-500 to-pink-500 p-3 rounded-xl text-white text-2xl">ğŸ›’</div>
                  <div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Lista Spesa</h1>
                    <p class="text-sm text-gray-500">ğŸ‘¥ Famiglia</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <button onclick="showStatistics()" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 text-white hover:shadow-lg active:scale-95 transition-all">
                    <span class="text-2xl">ğŸ“Š</span>
                    <span class="text-xs font-semibold">Stats</span>
                  </button>
                  <button onclick="getRecipes()" class="flex flex-col items-center justify-center w-16 h-16 rounded-xl bg-gradient-to-br from-orange-500 to-red-500 text-white hover:shadow-lg active:scale-95 transition-all">
                    <span class="text-2xl">ğŸ‘¨â€ğŸ³</span>
                    <span class="text-xs font-semibold">Ricette</span>
                  </button>
                  <div class="text-right">
                    <div class="text-3xl font-bold text-purple-600">${uncheckedCount}</div>
                    <div class="text-sm text-gray-500">da comprare</div>
                  </div>
                </div>
              </div>

              <div class="flex gap-2 mb-3">
                <input type="text" id="newItemInput" placeholder="Es: mele, pane..." class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-purple-400 focus:outline-none text-base" />
                <label class="cursor-pointer">
                  <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden" />
                  <div class="w-12 h-12 rounded-xl border-2 ${state.selectedPhoto ? 'border-purple-400 bg-purple-50' : 'border-gray-200'} flex items-center justify-center overflow-hidden">
                    ${state.selectedPhoto ? `<img src="${state.selectedPhoto}" class="w-full h-full object-cover" />` : '<span class="text-2xl">ğŸ“·</span>'}
                  </div>
                </label>
                <button onclick="addItem()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-xl font-semibold">+</button>
              </div>

              ${checkedCount > 0 ? `
                <button onclick="clearCompleted()" class="text-sm text-gray-500 hover:text-red-500 py-2">ğŸ—‘ï¸ Rimuovi completati (${checkedCount})</button>
              ` : ''}
            </div>

            <div class="space-y-3">
              ${state.items.length === 0 ? `
                <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
                  <div class="text-6xl mb-4">ğŸ›’</div>
                  <p class="text-gray-400 text-lg">La lista Ã¨ vuota!</p>
                </div>
              ` : state.items.map(item => `
                <div class="bg-white rounded-xl shadow-lg p-4 slide-in ${item.checked ? 'opacity-60' : ''}">
                  <div class="flex items-center gap-3">
                    <button onclick="toggleItem('${item.id}')" class="flex-shrink-0 w-10 h-10 rounded-xl border-2 flex items-center justify-center ${item.checked ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}">
                      ${item.checked ? 'âœ“' : ''}
                    </button>
                    ${item.photo ? `
                      <div class="w-14 h-14 rounded-xl overflow-hidden flex-shrink-0 border-2 border-gray-100">
                        <img src="${item.photo}" alt="${item.name}" class="w-full h-full object-cover" />
                      </div>
                    ` : `
                      <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-3xl flex-shrink-0">
                        ${item.icon}
                      </div>
                    `}
                    <div class="flex-1 font-semibold text-lg ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'}">${item.name}</div>
                    <button onclick="deleteItem('${item.id}')" class="w-10 h-10 rounded-xl bg-red-50 hover:bg-red-100 text-red-500 flex items-center justify-center">Ã—</button>
                  </div>
                </div>
              `).join('')}
            </div>

            ${state.frequentItems.length > 0 ? `
              <div class="bg-white rounded-2xl shadow-xl p-4 mt-4">
                <div class="flex items-center justify-between mb-4">
                  <button onclick="toggleFrequent()" class="flex items-center gap-2 text-lg font-semibold text-gray-700">
                    ğŸ• Prodotti Frequenti (${state.frequentItems.length})
                    <span class="text-2xl">${state.showFrequent ? 'â–¼' : 'â–¶'}</span>
                  </button>
                  ${state.showFrequent ? `
                    <div class="flex gap-2">
                      <button 
                        onclick="setSortMode('usage')" 
                        class="px-3 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.frequentSortMode === 'usage' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                      >
                        â­ PiÃ¹ usati
                      </button>
                      <button 
                        onclick="setSortMode('alphabetical')" 
                        class="px-3 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.frequentSortMode === 'alphabetical' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                      >
                        ğŸ”¤ A-Z
                      </button>
                    </div>
                  ` : ''}
                </div>
                ${state.showFrequent ? `
                  <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                    ${sortedFrequent.map(freq => {
                      const isInList = state.items.some(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
                      return `
                        <div class="relative group rounded-xl p-3 border-2 ${isInList ? 'border-green-300 bg-green-50' : 'border-gray-200 cursor-pointer hover:border-purple-300'}" onclick="${!isInList ? `addFromFrequent('${freq.id}')` : ''}">
                          <button onclick="event.stopPropagation(); removeFromFrequent('${freq.id}')" class="absolute top-1 right-1 w-6 h-6 rounded-full bg-red-100 text-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 z-10">Ã—</button>
                          <div class="flex flex-col items-center gap-2">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-2xl">${freq.icon}</div>
                            <div class="text-xs font-medium truncate w-full text-center">${freq.name}</div>
                            <div class="text-xs text-gray-400">â­ ${freq.usageCount || 1}x</div>
                          </div>
                          ${isInList ? '<div class="absolute inset-0 flex items-center justify-center bg-green-500 bg-opacity-20 rounded-xl"><span class="text-2xl">âœ“</span></div>' : ''}
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : ''}
              </div>
            ` : ''}

            ${state.showStatistics ? `
              <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="hideStatistics()">
                <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                  <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-6 rounded-t-3xl">
                    <div class="flex items-center justify-between">
                      <div>
                        <h2 class="text-2xl font-bold">ğŸ“Š Statistiche Acquisti</h2>
                        <p class="text-blue-100 text-sm mt-1">I prodotti piÃ¹ comprati</p>
                      </div>
                      <button onclick="hideStatistics()" class="w-10 h-10 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 flex items-center justify-center text-2xl">Ã—</button>
                    </div>
                  </div>
                  
                  <div class="p-6">
                    ${state.statistics.length === 0 ? `
                      <div class="text-center py-12">
                        <div class="text-6xl mb-4">ğŸ“ˆ</div>
                        <p class="text-gray-400 text-lg">Nessun acquisto registrato!</p>
                        <p class="text-gray-400 text-sm mt-2">Spunta i prodotti per tracciare le statistiche</p>
                      </div>
                    ` : `
                      <div class="space-y-3">
                        ${state.statistics
                          .sort((a, b) => (b.count || 0) - (a.count || 0))
                          .map(stat => {
                            const maxCount = Math.max(...state.statistics.map(s => s.count || 0));
                            const percentage = ((stat.count || 0) / maxCount) * 100;
                            return `
                              <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-4">
                                <div class="flex items-center gap-3 mb-2">
                                  <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center text-2xl">${stat.icon}</div>
                                  <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${stat.name}</div>
                                    <div class="text-xs text-gray-500">Ultimo: ${new Date(stat.lastPurchase).toLocaleDateString('it-IT')}</div>
                                  </div>
                                  <div class="text-right">
                                    <div class="text-2xl font-bold text-blue-600">${stat.count || 0}</div>
                                    <div class="text-xs text-gray-500">acquisti</div>
                                  </div>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                  <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                              </div>
                            `;
                          }).join('')}
                      </div>
                      <div class="mt-6 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
                        <div class="text-sm font-semibold text-blue-800 mb-2">ğŸ“ˆ Riepilogo</div>
                        <div class="grid grid-cols-2 gap-3 text-center">
                          <div>
                            <div class="text-2xl font-bold text-blue-600">${state.statistics.length}</div>
                            <div class="text-xs text-gray-600">Prodotti diversi</div>
                          </div>
                          <div>
                            <div class="text-2xl font-bold text-blue-600">${state.statistics.reduce((sum, s) => sum + (s.count || 0), 0)}</div>
                            <div class="text-xs text-gray-600">Acquisti totali</div>
                          </div>
