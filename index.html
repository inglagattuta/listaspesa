<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lista della Spesa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    body {
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }
    button, input {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
  <div id="app" class="p-3 md:p-4"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBmWi-5wQ97PA4TanAC5mHFAqmsNR9aUpE",
      authDomain: "lista-spesa-famiglia-95127.firebaseapp.com",
      databaseURL: "https://lista-spesa-famiglia-95127-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lista-spesa-famiglia-95127",
      storageBucket: "lista-spesa-famiglia-95127.firebasestorage.app",
      messagingSenderId: "131762886904",
      appId: "1:131762886904:web:068e00b3e2e08235e9c30d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getProductIcon(name) {
      const n = name.toLowerCase();
      if (n.includes('mela') || n.includes('mele')) return 'üçé';
      if (n.includes('banana') || n.includes('banane')) return 'üçå';
      if (n.includes('arancia') || n.includes('arance')) return 'üçä';
      if (n.includes('limone') || n.includes('limoni')) return 'üçã';
      if (n.includes('fragola') || n.includes('fragole')) return 'üçì';
      if (n.includes('pesca') || n.includes('pesche')) return 'üçë';
      if (n.includes('uva')) return 'üçá';
      if (n.includes('pomodor')) return 'üçÖ';
      if (n.includes('carota') || n.includes('carote')) return 'ü•ï';
      if (n.includes('insalata') || n.includes('lattuga')) return 'ü•¨';
      if (n.includes('broccoli')) return 'ü•¶';
      if (n.includes('cipolla') || n.includes('cipolle')) return 'üßÖ';
      if (n.includes('patata') || n.includes('patate')) return 'ü•î';
      if (n.includes('pollo') || n.includes('tacchino')) return 'üçó';
      if (n.includes('carne') || n.includes('bistecca')) return 'ü•©';
      if (n.includes('pesce') || n.includes('salmone')) return 'üêü';
      if (n.includes('latte')) return 'ü•õ';
      if (n.includes('formaggio')) return 'üßÄ';
      if (n.includes('uova') || n.includes('uovo')) return 'ü•ö';
      if (n.includes('pane')) return 'üçû';
      if (n.includes('pasta')) return 'üçù';
      if (n.includes('pizza')) return 'üçï';
      if (n.includes('riso')) return 'üçö';
      if (n.includes('biscotti')) return 'üç™';
      if (n.includes('cioccolat')) return 'üç´';
      if (n.includes('acqua')) return 'üíß';
      if (n.includes('caff√®') || n.includes('caffe')) return '‚òï';
      if (n.includes('birra')) return 'üç∫';
      if (n.includes('vino')) return 'üç∑';
      if (n.includes('carta igienica') || n.includes('scottex')) return 'üßª';
      if (n.includes('sapone') || n.includes('shampoo')) return 'üß¥';
      if (n.includes('detersivo')) return 'üßº';
      return 'üõí';
    }

    function getProductColor(emoji) {
      const colorMap = {
        'üçé': 'from-red-400 to-rose-500',
        'üçå': 'from-yellow-400 to-amber-500',
        'üçä': 'from-orange-400 to-orange-500',
        'üçÖ': 'from-red-500 to-rose-600',
        'ü•ï': 'from-orange-500 to-amber-600',
        'ü•¨': 'from-green-400 to-emerald-500',
        'ü•¶': 'from-green-500 to-emerald-600',
        'üçó': 'from-amber-500 to-orange-600',
        'ü•©': 'from-red-600 to-rose-700',
        'üêü': 'from-blue-400 to-cyan-500',
        'ü•õ': 'from-blue-300 to-cyan-400',
        'üßÄ': 'from-yellow-500 to-amber-600',
        'üçû': 'from-amber-400 to-orange-500',
        'üçù': 'from-yellow-400 to-orange-400',
        '‚òï': 'from-amber-700 to-orange-800',
        'üç´': 'from-amber-800 to-orange-900',
        'üíß': 'from-blue-400 to-cyan-500',
        'üßª': 'from-gray-300 to-gray-400',
        'üß¥': 'from-purple-400 to-pink-400'
      };
      return colorMap[emoji] || 'from-purple-400 to-pink-500';
    }

    let state = {
      items: [],
      frequentItems: [],
      showFrequent: true,
      newItem: '',
      message: null,
      showMessageInput: false,
      imagePreview: null,
      imageData: null,
      showStats: false,
      stats: {}
    };

    const itemsRef = ref(db, 'shoppingList');
    const frequentRef = ref(db, 'frequentItems');
    const messageRef = ref(db, 'familyMessage');
    const statsRef = ref(db, 'purchaseStats');

    onValue(itemsRef, (snapshot) => {
      const data = snapshot.val();
      state.items = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(frequentRef, (snapshot) => {
      const data = snapshot.val();
      state.frequentItems = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(messageRef, (snapshot) => {
      state.message = snapshot.val();
      render();
    });

    onValue(statsRef, (snapshot) => {
      state.stats = snapshot.val() || {};
      render();
    });

    async function addItem() {
      const name = state.newItem.trim();
      if (!name) return;

      const icon = getProductIcon(name);
      const newItemRef = push(itemsRef);
      await set(newItemRef, {
        name: name,
        icon: icon,
        checked: false,
        addedAt: new Date().toISOString(),
        image: state.imageData || null
      });

      const exists = state.frequentItems.find(f => f.name.toLowerCase() === name.toLowerCase());
      if (!exists) {
        const newFreqRef = push(frequentRef);
        await set(newFreqRef, {
          name: name,
          icon: icon,
          usageCount: 1,
          lastUsed: new Date().toISOString()
        });
      }

      state.newItem = '';
      state.imagePreview = null;
      state.imageData = null;
      const input = document.getElementById('newItemInput');
      const imageInput = document.getElementById('imageInput');
      if (input) input.value = '';
      if (imageInput) imageInput.value = '';
      render();
    }

    async function addFromFrequent(freq) {
      const exists = state.items.find(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
      if (exists) return;

      const newItemRef = push(itemsRef);
      await set(newItemRef, {
        name: freq.name,
        icon: freq.icon,
        checked: false,
        addedAt: new Date().toISOString(),
        image: null
      });

      const freqRef = ref(db, 'frequentItems/' + freq.id);
      await update(freqRef, {
        usageCount: freq.usageCount + 1,
        lastUsed: new Date().toISOString()
      });
    }

    async function toggleItem(id) {
      console.log('toggleItem chiamato per id:', id);
      const item = state.items.find(i => i.id === id);
      console.log('Item trovato:', item);
      
      if (!item) {
        console.error('Item non trovato!');
        return;
      }
      
      const itemRef = ref(db, 'shoppingList/' + id);
      
      if (!item.checked) {
        console.log('Marcando come acquistato, salvando statistica...');
        const statsKey = item.name.toLowerCase().replace(/\s+/g, '_');
        const statsItemRef = ref(db, 'purchaseStats/' + statsKey);
        const currentStat = state.stats[statsKey] || { name: item.name, count: 0, icon: item.icon };
        
        console.log('Salvando in purchaseStats/' + statsKey);
        console.log('Dati da salvare:', {
          name: item.name,
          icon: item.icon,
          count: currentStat.count + 1,
          lastPurchase: new Date().toISOString()
        });
        
        try {
          await set(statsItemRef, {
            name: item.name,
            icon: item.icon,
            count: currentStat.count + 1,
            lastPurchase: new Date().toISOString()
          });
          console.log('Statistica salvata con successo!');
        } catch (error) {
          console.error('Errore nel salvare la statistica:', error);
        }
      }
      
      try {
        await update(itemRef, { checked: !item.checked });
        console.log('Item aggiornato con successo');
      } catch (error) {
        console.error('Errore nell\'aggiornare item:', error);
      }
    }

    async function deleteItem(id) {
      await remove(ref(db, 'shoppingList/' + id));
    }

    async function removeFromFrequent(id) {
      await remove(ref(db, 'frequentItems/' + id));
    }

    async function clearCompleted() {
      const completed = state.items.filter(i => i.checked);
      for (const item of completed) {
        await remove(ref(db, 'shoppingList/' + item.id));
      }
    }

    async function saveMessage() {
      const input = document.getElementById('messageInput');
      const messageText = input ? input.value.trim() : '';
      if (!messageText) {
        alert('Scrivi un messaggio prima di pubblicare!');
        return;
      }

      try {
        await set(messageRef, {
          text: messageText,
          author: 'Famiglia',
          timestamp: new Date().toISOString()
        });
        state.showMessageInput = false;
        render();
      } catch (error) {
        console.error('Errore:', error);
        alert('Errore nel pubblicare il messaggio');
      }
    }

    async function deleteMessage() {
      await remove(messageRef);
    }

    // Definisco le funzioni globali PRIMA del render
    window.addItem = addItem;
    window.toggleItem = toggleItem;
    window.deleteItem = deleteItem;
    window.addFromFrequent = function(id) {
      const freq = state.frequentItems.find(f => f.id === id);
      if (freq) addFromFrequent(freq);
    };
    window.removeFromFrequent = removeFromFrequent;
    window.clearCompleted = clearCompleted;
    window.toggleFrequent = function() {
      state.showFrequent = !state.showFrequent;
      render();
    };
    window.showMessageForm = function() {
      state.showMessageInput = true;
      render();
      setTimeout(() => {
        const input = document.getElementById('messageInput');
        if (input) input.focus();
      }, 100);
    };
    window.cancelMessage = function() {
      state.showMessageInput = false;
      render();
    };
    window.saveMessage = saveMessage;
    window.deleteMessage = deleteMessage;
    window.removeImage = function() {
      state.imagePreview = null;
      state.imageData = null;
      const imageInput = document.getElementById('imageInput');
      if (imageInput) imageInput.value = '';
      render();
    };
    window.toggleStats = function() {
      state.showStats = !state.showStats;
      render();
    };

    function render() {
      const uncheckedCount = state.items.filter(i => !i.checked).length;
      const checkedCount = state.items.filter(i => i.checked).length;
      const sortedFrequent = state.frequentItems.slice().sort((a, b) => b.usageCount - a.usageCount);

      let html = '<div class="max-w-4xl mx-auto pb-6">';

      // Statistiche
      if (state.showStats) {
        html += '<div class="bg-white rounded-2xl md:rounded-3xl shadow-xl p-4 md:p-6 mb-4 md:mb-6">';
        html += '<div class="flex items-center justify-between mb-4">';
        html += '<div class="flex items-center gap-2"><div class="text-2xl md:text-3xl">üìä</div>';
        html += '<h2 class="text-xl md:text-2xl font-bold text-gray-800">Statistiche Acquisti</h2></div>';
        html += '<button onclick="window.toggleStats()" class="w-10 h-10 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center">‚úï</button>';
        html += '</div>';

        const statsArray = Object.values(state.stats);
        if (statsArray.length === 0) {
          html += '<div class="text-center py-8"><div class="text-5xl mb-3">üìà</div>';
          html += '<p class="text-gray-400">Nessuna statistica ancora</p>';
          html += '<p class="text-sm text-gray-400 mt-1">Inizia a completare gli acquisti!</p></div>';
        } else {
          const sortedStats = statsArray.sort((a, b) => b.count - a.count).slice(0, 10);
          const maxCount = Math.max(...statsArray.map(s => s.count));
          
          html += '<div class="space-y-3">';
          sortedStats.forEach((stat, index) => {
            const percentage = (stat.count / maxCount) * 100;
            html += '<div class="relative">';
            html += '<div class="flex items-center gap-3 relative z-10">';
            html += '<div class="w-12 h-12 rounded-xl bg-gradient-to-br ' + getProductColor(stat.icon) + ' flex items-center justify-center text-3xl shadow-md">' + stat.icon + '</div>';
            html += '<div class="flex-1"><div class="font-semibold text-lg">' + stat.name + '</div>';
            html += '<div class="text-sm text-gray-500">Acquistato ' + stat.count + ' ' + (stat.count === 1 ? 'volta' : 'volte') + '</div></div>';
            html += '<div class="flex items-center gap-2"><div class="text-3xl font-bold text-purple-600">' + stat.count + '</div>';
            if (index < 3) {
              html += '<div class="text-2xl">' + (index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â') + '</div>';
            }
            html += '</div></div>';
            html += '<div class="absolute left-0 top-0 h-full bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl" style="width: ' + percentage + '%; opacity: 0.3;"></div>';
            html += '</div>';
          });
          html += '</div>';

          const totalProducts = Object.keys(state.stats).length;
          const totalPurchases = statsArray.reduce((sum, s) => sum + s.count, 0);
          const maxPurchases = Math.max(...statsArray.map(s => s.count));
          const avgPurchases = Math.round(totalPurchases / totalProducts) || 0;

          html += '<div class="mt-6 pt-6 border-t border-gray-200"><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">';
          html += '<div><div class="text-3xl font-bold text-purple-600">' + totalProducts + '</div><div class="text-sm text-gray-500">Prodotti diversi</div></div>';
          html += '<div><div class="text-3xl font-bold text-pink-600">' + totalPurchases + '</div><div class="text-sm text-gray-500">Acquisti totali</div></div>';
          html += '<div><div class="text-3xl font-bold text-amber-600">' + maxPurchases + '</div><div class="text-sm text-gray-500">Record acquisti</div></div>';
          html += '<div><div class="text-3xl font-bold text-blue-600">' + avgPurchases + '</div><div class="text-sm text-gray-500">Media acquisti</div></div>';
          html += '</div></div>';
        }
        html += '</div>';
      }

      // Bacheca
      if (state.message) {
        const msgDate = new Date(state.message.timestamp).toLocaleString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        html += '<div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl shadow-lg p-4 md:p-6 mb-4 relative">';
        html += '<button onclick="window.deleteMessage()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-amber-100 hover:bg-amber-200 text-amber-600 flex items-center justify-center">‚úï</button>';
        html += '<div class="flex items-start gap-3 pr-8"><div class="text-4xl">üìå</div><div class="flex-1">';
        html += '<div class="text-sm text-amber-600 font-semibold mb-1">BACHECA FAMIGLIA</div>';
        html += '<div class="text-lg text-gray-800 font-medium">' + state.message.text + '</div>';
        html += '<div class="text-xs text-amber-600 mt-2">' + msgDate + '</div>';
        html += '</div></div></div>';
      } else if (state.showMessageInput) {
        html += '<div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 mb-4">';
        html += '<div class="flex items-center gap-2 mb-3"><div class="text-2xl">üìå</div>';
        html += '<div class="text-lg font-semibold text-gray-700">Nuovo messaggio bacheca</div></div>';
        html += '<textarea id="messageInput" placeholder="Scrivi un messaggio..." class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:outline-none text-base resize-none" rows="3"></textarea>';
        html += '<div class="flex gap-2 mt-3">';
        html += '<button onclick="window.saveMessage()" class="flex-1 bg-gradient-to-r from-amber-500 to-yellow-500 text-white px-6 py-3 rounded-xl hover:shadow-lg font-semibold">Pubblica</button>';
        html += '<button onclick="window.cancelMessage()" class="px-6 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold">Annulla</button>';
        html += '</div></div>';
      } else {
        html += '<button onclick="window.showMessageForm()" class="w-full bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-dashed border-amber-300 rounded-2xl p-4 md:p-6 mb-4 hover:border-amber-400 hover:shadow-lg">';
        html += '<div class="flex items-center justify-center gap-3 text-amber-600"><div class="text-4xl">üìå</div>';
        html += '<div class="text-lg font-semibold">Aggiungi messaggio bacheca</div></div></button>';
      }

      // Header lista
      html += '<div class="bg-white rounded-2xl shadow-xl p-4 md:p-8 mb-4">';
      html += '<div class="flex items-center justify-between mb-4">';
      html += '<div class="flex items-center gap-3">';
      html += '<div class="bg-gradient-to-br from-purple-500 to-pink-500 p-3 rounded-2xl text-white"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>';
      html += '<div><h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Lista Spesa</h1>';
      html += '<p class="text-sm text-gray-500"><svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg> Famiglia</p></div></div>';
      html += '<div class="flex items-center gap-3">';
      html += '<button onclick="window.toggleStats()" class="flex flex-col items-center px-3 py-2 rounded-xl bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200">';
      html += '<div class="text-2xl">&#128202;</div><div class="text-xs font-semibold text-purple-700 hidden md:block">Stats</div></button>';
      html += '<div class="text-right"><div class="text-3xl font-bold text-purple-600">' + uncheckedCount + '</div>';
      html += '<div class="text-sm text-gray-500">da comprare</div></div></div></div>';

      // Form aggiungi
      html += '<div class="flex flex-col gap-3 mb-3">';
      html += '<div class="flex flex-col md:flex-row gap-3">';
      html += '<input type="text" id="newItemInput" placeholder="Es: mele, pane, latte..." class="flex-1 px-6 py-4 rounded-xl border-2 border-gray-200 focus:border-purple-400 focus:outline-none text-lg" />';
      html += '<button onclick="window.addItem()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl hover:shadow-lg font-semibold"><svg class="w-6 h-6 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Aggiungi</button>';
      html += '</div>';
      
      html += '<div class="flex items-center gap-3">';
      html += '<input type="file" id="imageInput" accept="image/*" class="hidden" />';
      html += '<label for="imageInput" class="flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-dashed border-gray-300 hover:border-purple-400 cursor-pointer text-sm text-gray-600">';
      html += '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>';
      html += (state.imagePreview ? 'Cambia foto' : 'Aggiungi foto');
      html += '</label>';
      if (state.imagePreview) {
        html += '<button onclick="window.removeImage()" class="px-3 py-2 rounded-lg bg-red-50 hover:bg-red-100 text-red-500 text-sm">Rimuovi</button>';
      }
      html += '</div>';
      
      if (state.imagePreview) {
        html += '<div class="w-24 h-24 rounded-xl overflow-hidden border-2 border-purple-200"><img src="' + state.imagePreview + '" alt="Anteprima" class="w-full h-full object-cover" /></div>';
      }
      html += '</div>';

      if (checkedCount > 0) {
        html += '<button onclick="window.clearCompleted()" class="text-sm text-gray-500 hover:text-red-500 flex items-center gap-2 py-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Rimuovi completati (' + checkedCount + ')</button>';
      }
      html += '</div>';

      // Lista prodotti
      html += '<div class="space-y-3">';
      if (state.items.length === 0) {
        html += '<div class="bg-white rounded-2xl shadow-lg p-12 text-center">';
        html += '<div class="text-6xl mb-4">üõí</div><p class="text-gray-400 text-lg">La lista √® vuota!</p>';
        if (state.frequentItems.length > 0) {
          html += '<p class="text-gray-400 text-sm mt-2">üí° Usa i prodotti frequenti</p>';
        }
        html += '</div>';
      } else {
        state.items.forEach(item => {
          html += '<div class="bg-white rounded-xl shadow-lg p-5 slide-in ' + (item.checked ? 'opacity-60' : '') + '">';
          html += '<div class="flex items-center gap-4">';
          html += '<button onclick="window.toggleItem(\'' + item.id + '\')" class="w-12 h-12 rounded-xl border-3 flex items-center justify-center ' + (item.checked ? 'bg-gradient-to-br from-green-400 to-emerald-500 text-white' : 'border-gray-300') + '">';
          if (item.checked) html += '‚úì';
          html += '</button>';
          
          if (item.image) {
            html += '<div class="w-16 h-16 rounded-xl overflow-hidden shadow-md"><img src="' + item.image + '" class="w-full h-full object-cover" /></div>';
          } else {
            html += '<div class="w-16 h-16 rounded-xl bg-gradient-to-br ' + getProductColor(item.icon) + ' flex items-center justify-center text-4xl shadow-md">' + item.icon + '</div>';
          }
          
          html += '<div class="flex-1"><div class="font-semibold text-xl ' + (item.checked ? 'line-through text-gray-400' : 'text-gray-800') + '">' + item.name + '</div></div>';
          html += '<button onclick="window.deleteItem(\'' + item.id + '\')" class="w-12 h-12 rounded-xl bg-red-50 hover:bg-red-100 text-red-500 flex items-center justify-center">‚úï</button>';
          html += '</div></div>';
        });
      }
      html += '</div>';

      html += '<div class="mt-8 text-center text-gray-400 text-sm">üí° Sincronizzato in tempo reale</div>';

      // Prodotti frequenti
      if (state.frequentItems.length > 0) {
        html += '<div class="bg-white rounded-2xl shadow-xl p-6 mt-6">';
        html += '<button onclick="window.toggleFrequent()" class="flex items-center gap-2 text-lg font-semibold text-gray-700 mb-4 w-full">';
        html += 'üïí Prodotti Frequenti (' + state.frequentItems.length + ')';
        html += '<span class="ml-auto text-2xl">' + (state.showFrequent ? '‚ñº' : '‚ñ∂') + '</span></button>';
        
        if (state.showFrequent) {
          html += '<div class="grid grid-cols-3 md:grid-cols-5 gap-3">';
          sortedFrequent.forEach(freq => {
            const isInList = state.items.some(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
            html += '<div class="relative group rounded-xl p-3 border-2 ' + (isInList ? 'border-green-300 bg-green-50' : 'border-gray-200 hover:border-purple-300 cursor-pointer') + '" onclick="' + (!isInList ? 'window.addFromFrequent(\'' + freq.id + '\')' : '') + '">';
            html += '<button onclick="event.stopPropagation(); window.removeFromFrequent(\'' + freq.id + '\')" class="absolute top-1 right-1 w-6 h-6 rounded-full bg-red-100 hover:bg-red-200 text-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100">‚úï</button>';
            html += '<div class="flex flex-col items-center gap-2">';
            html += '<div class="w-14 h-14 rounded-xl bg-gradient-to-br ' + getProductColor(freq.icon) + ' flex items-center justify-center text-3xl shadow-md">' + freq.icon + '</div>';
            html += '<div class="text-center w-full"><div class="font-medium text-sm truncate">' + freq.name + '</div>';
            html += '<div class="text-xs text-gray-400">‚≠ê ' + freq.usageCount + 'x</div></div></div>';
            if (isInList) {
              html += '<div class="absolute inset-0 flex items-center justify-center bg-green-500 bg-opacity-20 rounded-xl"><span class="text-4xl">‚úì</span></div>';
            }
            html += '</div>';
          });
          html += '</div>';
        }
        html += '</div>';
      }

      html += '</div>';

      document.getElementById('app').innerHTML = html;

      // Event listeners
      const input = document.getElementById('newItemInput');
      if (input) {
        input.value = state.newItem;
        input.addEventListener('input', (e) => {
          state.newItem = e.target.value;
        });
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') addItem();
        });
      }

      const imageInput = document.getElementById('imageInput');
      if (imageInput) {
        imageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              state.imagePreview = event.target.result;
              state.imageData = event.target.result;
              render();
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    render();
  </script>
</body>
</html>
