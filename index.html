<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lista della Spesa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in { animation: slideIn 0.3s ease-out; }
    body {
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }
    button, input {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">
  <div id="app" class="p-3 md:p-4"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBmWi-5wQ97PA4TanAC5mHFAqmsNR9aUpE",
      authDomain: "lista-spesa-famiglia-95127.firebaseapp.com",
      databaseURL: "https://lista-spesa-famiglia-95127-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "lista-spesa-famiglia-95127",
      storageBucket: "lista-spesa-famiglia-95127.firebasestorage.app",
      messagingSenderId: "131762886904",
      appId: "1:131762886904:web:068e00b3e2e08235e9c30d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const icons = {
      cart: '<svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
      plus: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
      check: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>',
      x: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>',
      trash: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>',
      users: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
      history: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
      star: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>'
    };

    function getProductIcon(name) {
      const n = name.toLowerCase();
      if (n.includes('mela') || n.includes('mele')) return 'ðŸŽ';
      if (n.includes('banana') || n.includes('banane')) return 'ðŸŒ';
      if (n.includes('arancia') || n.includes('arance')) return 'ðŸŠ';
      if (n.includes('pane')) return 'ðŸž';
      if (n.includes('latte')) return 'ðŸ¥›';
      if (n.includes('pasta')) return 'ðŸ';
      if (n.includes('pomodor')) return 'ðŸ…';
      if (n.includes('formaggio')) return 'ðŸ§€';
      if (n.includes('uova')) return 'ðŸ¥š';
      return 'ðŸ›’';
    }

    function getProductColor(emoji) {
      const colorMap = {
        'ðŸŽ': 'from-red-400 to-rose-500',
        'ðŸŒ': 'from-yellow-400 to-amber-500',
        'ðŸŠ': 'from-orange-400 to-orange-500',
        'ðŸž': 'from-amber-400 to-orange-500',
        'ðŸ¥›': 'from-blue-300 to-cyan-400',
        'ðŸ': 'from-yellow-400 to-orange-400',
        'ðŸ…': 'from-red-500 to-rose-600',
        'ðŸ§€': 'from-yellow-500 to-amber-600',
        'ðŸ¥š': 'from-yellow-300 to-amber-400'
      };
      return colorMap[emoji] || 'from-purple-400 to-pink-500';
    }

    let state = {
      items: [],
      frequentItems: [],
      showFrequent: true,
      newItem: '',
      message: null,
      showMessageInput: false,
      imagePreview: null,
      imageData: null
    };

    const itemsRef = ref(db, 'shoppingList');
    const frequentRef = ref(db, 'frequentItems');
    const messageRef = ref(db, 'familyMessage');

    onValue(itemsRef, (snapshot) => {
      const data = snapshot.val();
      state.items = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(frequentRef, (snapshot) => {
      const data = snapshot.val();
      state.frequentItems = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
      render();
    });

    onValue(messageRef, (snapshot) => {
      state.message = snapshot.val();
      render();
    });

    async function addItem() {
      const name = state.newItem.trim();
      if (!name) return;

      const icon = getProductIcon(name);
      const newItemRef = push(itemsRef);
      await set(newItemRef, {
        name,
        icon,
        checked: false,
        addedAt: new Date().toISOString(),
        image: state.imageData || null
      });

      const exists = state.frequentItems.find(f => f.name.toLowerCase() === name.toLowerCase());
      if (!exists) {
        const newFreqRef = push(frequentRef);
        await set(newFreqRef, {
          name,
          icon,
          usageCount: 1,
          lastUsed: new Date().toISOString()
        });
      }

      state.newItem = '';
      state.imagePreview = null;
      state.imageData = null;
      const input = document.getElementById('newItemInput');
      const imageInput = document.getElementById('imageInput');
      if (input) input.value = '';
      if (imageInput) imageInput.value = '';
      if (input) input.focus();
      render();
    }

    async function addFromFrequent(freq) {
      const exists = state.items.find(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
      if (exists) return;

      const newItemRef = push(itemsRef);
      await set(newItemRef, {
        name: freq.name,
        icon: freq.icon,
        checked: false,
        addedAt: new Date().toISOString(),
        image: null
      });

      const freqRef = ref(db, `frequentItems/${freq.id}`);
      await update(freqRef, {
        usageCount: freq.usageCount + 1,
        lastUsed: new Date().toISOString()
      });
    }

    async function toggleItem(id) {
      const item = state.items.find(i => i.id === id);
      const itemRef = ref(db, `shoppingList/${id}`);
      await update(itemRef, { checked: !item.checked });
    }

    async function deleteItem(id) {
      await remove(ref(db, `shoppingList/${id}`));
    }

    async function removeFromFrequent(id) {
      await remove(ref(db, `frequentItems/${id}`));
    }

    async function clearCompleted() {
      const completed = state.items.filter(i => i.checked);
      for (const item of completed) {
        await remove(ref(db, `shoppingList/${item.id}`));
      }
    }

    async function saveMessage() {
      const input = document.getElementById('messageInput');
      const messageText = input?.value?.trim();
      if (!messageText) {
        alert('Scrivi un messaggio prima di pubblicare!');
        return;
      }

      try {
        await set(messageRef, {
          text: messageText,
          author: 'Famiglia',
          timestamp: new Date().toISOString()
        });
        state.showMessageInput = false;
        render();
      } catch (error) {
        console.error('Errore:', error);
        alert('Errore nel pubblicare il messaggio. Riprova!');
      }
    }

    async function deleteMessage() {
      await remove(messageRef);
      state.showMessageInput = false;
    }

    function render() {
      const uncheckedCount = state.items.filter(i => !i.checked).length;
      const checkedCount = state.items.filter(i => i.checked).length;
      const sortedFrequent = [...state.frequentItems].sort((a, b) => b.usageCount - a.usageCount);

      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="max-w-4xl mx-auto pb-6">
          ${state.message ? `
            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl md:rounded-3xl shadow-lg p-4 md:p-6 mb-4 md:mb-6 relative">
              <button onclick="window.deleteMessage()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-amber-100 hover:bg-amber-200 active:bg-amber-300 text-amber-600 flex items-center justify-center transition-colors">
                ${icons.x}
              </button>
              <div class="flex items-start gap-3 pr-8">
                <div class="text-3xl md:text-4xl">ðŸ“Œ</div>
                <div class="flex-1">
                  <div class="text-xs md:text-sm text-amber-600 font-semibold mb-1">BACHECA FAMIGLIA</div>
                  <div class="text-base md:text-lg text-gray-800 font-medium">${state.message.text}</div>
                  <div class="text-xs text-amber-600 mt-2">${new Date(state.message.timestamp).toLocaleString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</div>
                </div>
              </div>
            </div>
          ` : state.showMessageInput ? `
            <div class="bg-white rounded-2xl md:rounded-3xl shadow-xl p-4 md:p-6 mb-4 md:mb-6">
              <div class="flex items-center gap-2 mb-3">
                <div class="text-2xl">ðŸ“Œ</div>
                <div class="text-base md:text-lg font-semibold text-gray-700">Nuovo messaggio bacheca</div>
              </div>
              <textarea id="messageInput" placeholder="Scrivi un messaggio per la famiglia..." class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-amber-400 focus:outline-none transition-colors text-base resize-none" rows="3"></textarea>
              <div class="flex gap-2 mt-3">
                <button onclick="event.preventDefault(); window.saveMessage();" class="flex-1 bg-gradient-to-r from-amber-500 to-yellow-500 text-white px-6 py-3 rounded-xl hover:shadow-lg active:scale-95 transition-all font-semibold">Pubblica</button>
                <button onclick="event.preventDefault(); window.cancelMessage();" class="px-6 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 font-semibold transition-colors">Annulla</button>
              </div>
            </div>
          ` : `
            <button onclick="window.showMessageForm()" class="w-full bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-dashed border-amber-300 rounded-2xl md:rounded-3xl p-4 md:p-6 mb-4 md:mb-6 hover:border-amber-400 hover:shadow-lg active:scale-98 transition-all group">
              <div class="flex items-center justify-center gap-3 text-amber-600">
                <div class="text-3xl md:text-4xl">ðŸ“Œ</div>
                <div class="text-base md:text-lg font-semibold group-hover:text-amber-700">Aggiungi messaggio bacheca</div>
              </div>
            </button>
          `}

          <div class="bg-white rounded-2xl md:rounded-3xl shadow-xl p-4 md:p-8 mb-4 md:mb-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2 md:gap-3">
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 p-2 md:p-3 rounded-xl md:rounded-2xl text-white">${icons.cart}</div>
                <div>
                  <h1 class="text-xl md:text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Lista Spesa</h1>
                  <p class="text-xs md:text-sm text-gray-500 flex items-center gap-1 md:gap-2">${icons.users} Famiglia</p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-2xl md:text-3xl font-bold text-purple-600">${uncheckedCount}</div>
                <div class="text-xs md:text-sm text-gray-500">da comprare</div>
              </div>
            </div>

            <div class="flex flex-col gap-3 mb-3">
              <div class="flex flex-col md:flex-row gap-3">
                <input type="text" id="newItemInput" placeholder="Es: mele, pane, latte..." class="flex-1 px-4 md:px-6 py-4 md:py-3 rounded-xl border-2 border-gray-200 focus:border-purple-400 focus:outline-none transition-colors text-base md:text-lg" />
                <button onclick="window.addItem()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 md:px-8 py-4 md:py-3 rounded-xl hover:shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 font-semibold text-base md:text-base">${icons.plus} Aggiungi</button>
              </div>
              
              <div class="flex items-center gap-3">
                <input type="file" id="imageInput" accept="image/*" class="hidden" />
                <label for="imageInput" class="flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-dashed border-gray-300 hover:border-purple-400 cursor-pointer transition-colors text-sm text-gray-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  ${state.imagePreview ? 'Cambia immagine' : 'Aggiungi foto (opzionale)'}
                </label>
                ${state.imagePreview ? `<button onclick="window.removeImage()" class="px-3 py-2 rounded-lg bg-red-50 hover:bg-red-100 text-red-500 text-sm transition-colors">Rimuovi</button>` : ''}
              </div>
              
              ${state.imagePreview ? `<div class="relative w-24 h-24 rounded-xl overflow-hidden border-2 border-purple-200"><img src="${state.imagePreview}" alt="Anteprima" class="w-full h-full object-cover" /></div>` : ''}
            </div>

            ${checkedCount > 0 ? `<button onclick="window.clearCompleted()" class="text-sm md:text-base text-gray-500 hover:text-red-500 transition-colors flex items-center gap-2 py-2">${icons.trash} Rimuovi completati (${checkedCount})</button>` : ''}
          </div>

          <div class="space-y-3">
            ${state.items.length === 0 ? `
              <div class="bg-white rounded-2xl md:rounded-3xl shadow-lg p-8 md:p-12 text-center">
                <div class="text-5xl md:text-6xl mb-4">ðŸ›’</div>
                <p class="text-gray-400 text-base md:text-lg">La lista Ã¨ vuota!</p>
                ${state.frequentItems.length > 0 ? '<p class="text-gray-400 text-sm mt-2">ðŸ’¡ Usa i prodotti frequenti</p>' : ''}
              </div>
            ` : state.items.map(item => `
              <div class="bg-white rounded-xl md:rounded-2xl shadow-lg p-4 md:p-5 slide-in active:scale-98 transition-transform ${item.checked ? 'opacity-60' : ''}">
                <div class="flex items-center gap-3 md:gap-4">
                  <button onclick="window.toggleItem('${item.id}')" class="flex-shrink-0 w-12 h-12 md:w-10 md:h-10 rounded-xl border-3 flex items-center justify-center transition-all active:scale-90 ${item.checked ? 'bg-gradient-to-br from-green-400 to-emerald-500 border-green-500 text-white' : 'border-gray-300 hover:border-purple-400'}">
                    ${item.checked ? icons.check : ''}
                  </button>
                  ${item.image ? `
                    <div class="w-16 h-16 md:w-14 md:h-14 rounded-xl overflow-hidden flex-shrink-0 shadow-md">
                      <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover" />
                    </div>
                  ` : `
                    <div class="w-16 h-16 md:w-14 md:h-14 rounded-xl bg-gradient-to-br ${getProductColor(item.icon)} flex items-center justify-center text-4xl md:text-3xl flex-shrink-0 shadow-md">${item.icon}</div>
                  `}
                  <div class="flex-1 min-w-0">
                    <div class="font-semibold text-lg md:text-xl ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'} truncate">${item.name}</div>
                  </div>
                  <button onclick="window.deleteItem('${item.id}')" class="flex-shrink-0 w-12 h-12 md:w-10 md:h-10 rounded-xl bg-red-50 hover:bg-red-100 active:bg-red-200 text-red-500 flex items-center justify-center transition-colors">${icons.x}</button>
                </div>
              </div>
            `).join('')}
          </div>

          <div class="mt-6 md:mt-8 text-center text-gray-400 text-xs md:text-sm px-4">ðŸ’¡ Sincronizzato in tempo reale</div>

          ${state.frequentItems.length > 0 ? `
            <div class="bg-white rounded-2xl md:rounded-3xl shadow-xl p-4 md:p-6 mt-4 md:mt-6">
              <button onclick="window.toggleFrequent()" class="flex items-center gap-2 text-base md:text-lg font-semibold text-gray-700 mb-4 hover:text-purple-600 transition-colors w-full py-2">
                ${icons.history} Prodotti Frequenti (${state.frequentItems.length})
                <span class="ml-auto text-xl md:text-2xl">${state.showFrequent ? 'â–¼' : 'â–¶'}</span>
              </button>
              ${state.showFrequent ? `
                <div class="grid grid-cols-3 md:grid-cols-5 gap-2 md:gap-3">
                  ${sortedFrequent.map(freq => {
                    const isInList = state.items.some(i => i.name.toLowerCase() === freq.name.toLowerCase() && !i.checked);
                    return `
                      <div class="relative group rounded-xl p-3 border-2 transition-all active:scale-95 ${isInList ? 'border-green-300 bg-green-50' : 'border-gray-200 hover:border-purple-300 hover:shadow-md cursor-pointer'}" onclick="${!isInList ? `window.addFromFrequent('${freq.id}')` : ''}">
                        <button onclick="event.stopPropagation(); window.removeFromFrequent('${freq.id}')" class="absolute top-1 right-1 w-6 h-6 rounded-full bg-red-100 hover:bg-red-200 active:bg-red-300 text-red-500 flex items-center justify-center opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity z-10">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                        <div class="flex flex-col items-center gap-1 md:gap-2">
                          <div class="w-12 h-12 md:w-14 md:h-14 rounded-xl bg-gradient-to-br ${getProductColor(freq.icon)} flex items-center justify-center text-2xl md:text-3xl shadow-md">${freq.icon}</div>
                          <div class="text-center w-full">
                            <div class="font-medium text-xs md:text-sm truncate px-1">${freq.name}</div>
                            <div class="flex items-center justify-center gap-1 text-xs text-gray-400">
                              <span class="text-yellow-400">${icons.star}</span>
                              ${freq.usageCount}x
                            </div>
                          </div>
                        </div>
                        ${isInList ? `<div class="absolute inset-0 flex items-center justify-center bg-green-500 bg-opacity-20 rounded-xl"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg></div>` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;

      const input = document.getElementById('newItemInput');
      if (input) {
        input.value = state.newItem;
        input.addEventListener('input', (e) => {
          state.newItem = e.target.value;
        });
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') addItem();
        });
      }

      const imageInput = document.getElementById('imageInput');
      if (imageInput) {
        imageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              state.imagePreview = event.target.result;
              state.imageData = event.target.result;
              render();
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    window.addItem = addItem;
    window.toggleItem = toggleItem;
    window.deleteItem = deleteItem;
    window.addFromFrequent = (id) => {
      const freq = state.frequentItems.find(f => f.id === id);
      if (freq) addFromFrequent(freq);
    };
    window.removeFromFrequent = removeFromFrequent;
    window.clearCompleted = clearCompleted;
    window.toggleFrequent = () => {
      state.showFrequent = !state.showFrequent;
      render();
    };
    window.showMessageForm = () => {
      state.showMessageInput = true;
      render();
      setTimeout(() => document.getElementById('messageInput')?.focus(), 100);
    };
    window.cancelMessage = () => {
      state.showMessageInput = false;
      render();
    };
    window.saveMessage = saveMessage;
    window.deleteMessage = deleteMessage;
    window.removeImage = () => {
      state.imagePreview = null;
      state.imageData = null;
      const imageInput = document.getElementById('imageInput');
      if (imageInput) imageInput.value = '';
      render();
    };

    render();
  </script>
</body>
</html>
